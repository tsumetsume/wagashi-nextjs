#!/usr/bin/env tsx

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 */

import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
})

async function testConnection() {
  try {
    console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...')
    console.log('DATABASE_URL:', process.env.DATABASE_URL?.replace(/:[^:@]*@/, ':****@'))
    console.log('DIRECT_URL:', process.env.DIRECT_URL?.replace(/:[^:@]*@/, ':****@'))
    
    // æ¥ç¶šãƒ†ã‚¹ãƒˆ
    await prisma.$connect()
    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ­£å¸¸ã«æ¥ç¶šã§ãã¾ã—ãŸ')
    
    // ç°¡å˜ãªã‚¯ã‚¨ãƒªãƒ†ã‚¹ãƒˆ
    const result = await prisma.$queryRaw`SELECT version()`
    console.log('ğŸ“Š PostgreSQLãƒãƒ¼ã‚¸ãƒ§ãƒ³:', result)
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
    const tables = await prisma.$queryRaw`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public'
    `
    console.log('ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«:', tables)
    
  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error)
    
    if (error instanceof Error) {
      if (error.message.includes('ENOTFOUND')) {
        console.log('ğŸ’¡ ãƒ›ã‚¹ãƒˆåãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
      } else if (error.message.includes('ECONNREFUSED')) {
        console.log('ğŸ’¡ æ¥ç¶šãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒ¼ãƒˆç•ªå·ã¨ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
      } else if (error.message.includes('authentication failed')) {
        console.log('ğŸ’¡ èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
      } else if (error.message.includes('timeout')) {
        console.log('ğŸ’¡ æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚')
      }
    }
    
    process.exit(1)
  } finally {
    await prisma.$disconnect()
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if (require.main === module) {
  testConnection()
}